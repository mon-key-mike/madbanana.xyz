import{__awaiter as e}from"tslib";import t from"cross-fetch";import n from"debug";import{Buffer}from"buffer";import{PrivateKey as i,encrypt as o,decrypt as a}from"eciesjs";import{EventEmitter2 as c}from"eventemitter2";import{validate as s,v4 as r}from"uuid";import{io as l}from"socket.io-client";const d=n("KeyExchange:Layer"),u=n("SocketService:Layer"),h=n("Ecies:Layer"),m=n("RemoteCommunication:Layer");d.color="##95c44e",u.color="#f638d7",h.color="#465b9c",m.color="#47a2be";const g={KeyExchange:d,SocketService:u,Ecies:h,RemoteCommunication:m};let v,y=[],E=[];const S=(n,i)=>e(void 0,void 0,void 0,(function*(){v=i,E.push(n),function(n){return e(this,void 0,void 0,(function*(){if(!v||!n)return;!function(){const e=E;E=y,y=e}();const e=v.endsWith("/")?`${v}evt`:`${v}/evt`,i=Object.assign({},n);if(delete i.params,n.params)for(const[e,t]of Object.entries(n.params))i[e]=t;const o=JSON.stringify(i);g.RemoteCommunication(`[sendBufferedEvents] Sending ${y.length} analytics events to ${e}`);try{const n=yield t(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:o}),i=yield n.text();g.RemoteCommunication(`[sendBufferedEvents] Response: ${i}`),y.length=0}catch(e){}}))}(n).catch((()=>{}))}));class p{constructor(e){this.enabled=!0,(null==e?void 0:e.debug)&&n.enable("Ecies:Layer"),this.ecies=(null==e?void 0:e.privateKey)?i.fromHex(e.privateKey):new i,g.Ecies("[ECIES constructor()] initialized secret: ",this.ecies.toHex()),g.Ecies("[ECIES constructor()] initialized public: ",this.ecies.publicKey.toHex()),g.Ecies("[ECIES constructor()] init with",this)}generateECIES(){this.ecies=new i}getPublicKey(){return this.ecies.publicKey.toHex()}encrypt(e,t){let n=e;if(this.enabled)try{g.Ecies("[ECIES: encrypt()] using otherPublicKey",t);const i=Buffer.from(e),a=o(t,i);n=Buffer.from(a).toString("base64")}catch(n){throw g.Ecies("[ECIES: encrypt()] error encrypt:",n),g.Ecies("[ECIES: encrypt()] private: ",this.ecies.toHex()),g.Ecies("[ECIES: encrypt()] data: ",e),g.Ecies("[ECIES: encrypt()] otherkey: ",t),n}return n}decrypt(e){let t=e;if(this.enabled)try{g.Ecies("[ECIES: decrypt()] using privateKey",this.ecies.toHex());const n=Buffer.from(e.toString(),"base64");t=a(this.ecies.toHex(),n).toString()}catch(t){throw g.Ecies("[ECIES: decrypt()] error decrypt",t),g.Ecies("[ECIES: decrypt()] private: ",this.ecies.toHex()),g.Ecies("[ECIES: decrypt()] encryptedData: ",e),t}return t}getKeyInfo(){return{private:this.ecies.toHex(),public:this.ecies.publicKey.toHex()}}toString(){g.Ecies("[ECIES: toString()]",this.getKeyInfo())}}var C={name:"@metamask/sdk-communication-layer",version:"0.32.0",description:"",homepage:"https://github.com/MetaMask/metamask-sdk#readme",bugs:{url:"https://github.com/MetaMask/metamask-sdk/issues"},repository:{type:"git",url:"https://github.com/MetaMask/metamask-sdk.git",directory:"packages/sdk-communication-layer"},main:"dist/node/cjs/metamask-sdk-communication-layer.js",unpkg:"dist/browser/umd/metamask-sdk-communication-layer.js",module:"dist/node/es/metamask-sdk-communication-layer.js",browser:"dist/browser/es/metamask-sdk-communication-layer.js","react-native":"dist/react-native/es/metamask-sdk-communication-layer.js",types:"dist/types/src/index.d.ts",files:["/dist"],scripts:{"build:types":"tsc --project tsconfig.build.json --emitDeclarationOnly --outDir dist/types","build:clean":"yarn clean && yarn build",build:"yarn build:types && rollup -c --bundleConfigAsCjs","build:dev":"yarn build:types && NODE_ENV=dev rollup -c --bundleConfigAsCjs",dev:'concurrently "tsc --watch" "rollup -c --bundleConfigAsCjs -w"',"build:post-tsc":"echo 'N/A'","build:pre-tsc":"echo 'N/A'",size:"size-limit",clean:"rimraf ./dist",lint:"yarn lint:eslint && yarn lint:misc --check","lint:changelog":"../../scripts/validate-changelog.sh @metamask/sdk-communication-layer","lint:eslint":"eslint . --cache --ext js,ts","lint:fix":"yarn lint:eslint --fix && yarn lint:misc --write","lint:misc":"prettier '**/*.json' '**/*.md' '!CHANGELOG.md' --ignore-path ../../.gitignore","publish:preview":"yarn npm publish --tag preview",prepack:"../../scripts/prepack.sh",reset:"yarn clean && rimraf ./node_modules/",test:'jest --testPathIgnorePatterns "/e2e/"',"test:e2e":'jest --testPathPattern "/e2e/"',"test:coverage":"jest --coverage","test:ci":'jest --coverage --passWithNoTests --setupFilesAfterEnv ./jest-preload.js --testPathIgnorePatterns "/e2e/"',"test:dev":"jest",watch:"rollup -c --bundleConfigAsCjs -w"},dependencies:{bufferutil:"^4.0.8","date-fns":"^2.29.3",debug:"^4.3.4","utf-8-validate":"^5.0.2",uuid:"^8.3.2"},devDependencies:{"@jest/globals":"^29.3.1","@lavamoat/allow-scripts":"^2.3.1","@metamask/auto-changelog":"3.1.0","@metamask/eslint-config":"^6.0.0","@metamask/eslint-config-nodejs":"^6.0.0","@metamask/eslint-config-typescript":"^6.0.0","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-replace":"^6.0.1","@rollup/plugin-terser":"^0.4.4","@size-limit/preset-big-lib":"^11.0.2","@types/jest":"^29.2.4","@types/node":"^20.1.3","@types/uuid":"^9.0.0","@typescript-eslint/eslint-plugin":"^4.26.0","@typescript-eslint/parser":"^4.26.0",concurrently:"^9.1.2","cross-fetch":"^4.0.0",eciesjs:"^0.4.11",eslint:"^7.30.0","eslint-config-prettier":"^8.3.0","eslint-plugin-import":"^2.23.4","eslint-plugin-jest":"^24.4.0","eslint-plugin-jsdoc":"^36.1.0","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^3.4.0",eventemitter2:"^6.4.9",jest:"^29.3.1",prettier:"^2.3.0",rimraf:"^3.0.2",rollup:"^4.26.0","rollup-plugin-jscc":"^2.0.0","rollup-plugin-natives":"^0.7.5","rollup-plugin-node-builtins":"^2.1.2","rollup-plugin-node-globals":"^1.4.0","rollup-plugin-peer-deps-external":"^2.2.4","rollup-plugin-polyfill-node":"^0.13.0","rollup-plugin-sizes":"^1.0.6","rollup-plugin-typescript2":"^0.31.2","rollup-plugin-visualizer":"^5.12.0","size-limit":"^11.1.6","socket.io-client":"^4.5.1","stream-browserify":"^3.0.0","ts-jest":"^29.0.3","ts-node":"^10.9.1",typescript:"^5.6.3"},peerDependencies:{"cross-fetch":"^4.0.0",eciesjs:"*",eventemitter2:"^6.4.9","readable-stream":"^3.6.2","socket.io-client":"^4.5.1"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},lavamoat:{allowScripts:{"@lavamoat/preinstall-always-fail":!1,canvas:!0,"eciesjs>secp256k1":!1,"socket.io-client>engine.io-client>ws>bufferutil":!1,"socket.io-client>engine.io-client>ws>utf-8-validate":!1,